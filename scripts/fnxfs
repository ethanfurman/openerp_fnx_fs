#!/usr/local/sbin/suid-python --virtualenv

"""\
Various utilities for managing fnx_fs attached files.
"""

from __future__ import print_function
from antipathy import Path
from scription import *
from openerplib import get_connection

import os
import pwd

CONFIG = Path('/%s/config/fnx.ini' % os.environ['VIRTUAL_ENV'])

try:
    settings = OrmFile(CONFIG)
except Exception:
    print('WARNING: unable to process configfile; all parameters must be specified', file=stderr)
    HOST = ''
    USER = ''
    DB = ''
    PW = ''
    NETWORK_PW = ''
else:
    HOST = settings.openerp.host
    USER = settings.openerp.user
    DB = settings.openerp.db
    PW = settings.openerp.pw
    NETWORK_PW = settings.network.pw

openerp = None


@Script(
        host=('host where OpenERP instance is running', OPTION, None),
        db=('database to use', OPTION, None),
        user=('login name to use', OPTION, None),
        pw=('password for login name', OPTION, None),
        )
def main(host=HOST, db=DB, user=USER, pw=''):
    global Type, convert, _logger
    # set up openerp connection info
    if host:
        module.HOST = host
    if db:
        module.DB = db
    if user:
        module.USER = user
    if pw:
        module.PW = pw
    for req in ('HOST', 'USER', 'DB', 'PW'):
        if not module[req]:
            raise SystemExit('%r required; use --help for more info' % req)
    # link to openerp tables
    print('getting connection using %r, %r, %r' % (HOST, DB, USER), verbose=2)
    module.openerp = get_connection(hostname=HOST, database=DB, login=USER, password=PW)


@Command(
        tables=Spec('table(s) to initialize', ),
        )
def initialize(*tables):
    "add folder names to records for newly added files fields"
    for table in tables:
        print('getting model %r' % table, verbose=2)
        model = openerp.get_model(table)
        print('getting ids', verbose=2)
        ids = model.search([('id','!=',0)], context={'active_test':False})
        print('setting fnxfs_folder in %d ids' % len(ids))
        model._set_fnxfs_folder(ids)
        echo('%s: folder names added to %d records' % (table, len(ids)))


@Command(
        table=('table to check', ),
        field=('field to check', ),
        sort=Spec('sort by...', OPTION, choices=['field','display']),
        )
def file_paths(table=None, field=None, sort='field'):
    "display all tables with fnxfs.files fields and their paths"
    info = openerp.get_model('fnx_fs.fs', transient=True).fnxfs_table_info()
    rows = [('table','field name','field string','field path')]
    for table_name, fields in sorted(info.items()):
        if table is None or table == table_name:
            rows.append(None)
            lines = []
            for name, column in fields.items():
                lines.append((column['name'], column['display'], column['path']))
            if lines:
                if sort == 'field':
                    lines.sort(key=lambda l: l[0])
                elif sort == 'display':
                    lines.sort(key=lambda l: l[1])
                else:
                    abort('unknown sort option %r' % (sort, ))
                rows.append((table_name, lines[0][0], lines[0][1], lines[0][2]))
                for name, display, path in lines[1:]:
                    rows.append(('', name, display, path))
    echo(rows, border='table', table_header=False)


@Command(
        table=('table to check', ),
        field=('field to check', ),
        )
def prune(table=None, field=None):
    "remove empty directories"
    info = openerp.get_model('fnx_fs.fs', transient=True).fnxfs_table_info()
    for table_name, fields in sorted(info.items()):
        if table is None or table == table_name:
            print('checking', table_name)
            for field_desc in fields:
                if field is None or field == field_desc['name']:
                    print('   %s:' % field_desc['name'], end='')
                    # remove empty leafs
                    branch = Path(field_desc['path'])
                    removed = 0
                    for leaf in branch.listdir():
                        if not (branch/leaf).listdir():
                            branch.rmdir(leaf)
                            removed += 1
                    print('  %d removed' % removed)


@Command(
        state=Spec('state of leafs to check', choices=['alive', 'dead']),
        table=Spec('table to check', ),
        field=Spec('field to check', ),
        )
def leafs(state=None, table=None, field=None):
    info = openerp.get_model('fnx_fs.fs', transient=True).fnxfs_table_info()
    for table_name, fields in sorted(info.items()):
        if table is None or table == table_name:
            for field_desc in fields:
                if field is None or field == field_desc['name']:
                    # check for non-empty leafs
                    branch = Path(field_desc['path'])
                    for leaf in branch.listdir():
                        living = (branch/leaf).listdir()
                        if (
                                (state == 'alive' and living)
                             or (state == 'dead' and not living)
                            ):
                            echo(branch/leaf)


@Command(
        src=('file to copy', REQUIRED, 's', Path),
        dst=('where to put it (and possibly new name)', REQUIRED, 'd', Path),
        max_copies=('how many archival copies to keep', OPTION, int),
        )
def cp(src, dst, max_copies=0):
    """
    copy file into FnxFS structure, also archiving it

    dst -> table.name/record_specifier/field/filename.ext
    """
    IS_ROOT = os.geteuid() == 0
    try:
        OPENERP = tuple(pwd.getpwnam('openerp')[2:4])
    except KeyError:
        abort("user 'openerp' does not exist")
    if not src.exists():
        abort('%s does not exist' % (src, ))
    dst = dst.strip('/')
    if dst.count('/') == 2:
        table_name, record_name, field_name = dst.split('/', 2)
        leaf = src.filename
    elif dst.count('/') == 3:
        table_name, record_name, field_name, leaf = dst.split('/', 3)
    else:
        abort('invalid path: %r' % (dst, ))
    oe_table = openerp.get_model(table_name)
    records = oe_table.read([(oe_table._rec_name,'=',record_name)], fields=['fnxfs_folder'])
    if not records:
        abort('unable to find %s %r' % (oe_table._description, str(record_name)))
    root = oe_table._fnxfs_root
    trunk = oe_table._fnxfs_path
    branch = oe_table._all_columns[field_name].path
    path = Path(root) / trunk / branch
    for record in records:
        stem = record.fnxfs_folder
        dst =  path / stem / leaf
        if not dst.parent.exists():
            dst.parent.mkdir()
        print(dst, end=' ... ')
        src.copy(dst)
        print('ok')
        if IS_ROOT:
            dst.chown(*OPENERP)


Main()
